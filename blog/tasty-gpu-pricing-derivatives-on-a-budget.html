<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HZRVS8S0KQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-HZRVS8S0KQ');
  </script><link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/code.css">
  <link rel="icon" href="/favicon.ico">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Tasty GPU – Pricing Derivatives on a Budget | TastyCode</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Tasty GPU – Pricing Derivatives on a Budget" />
<meta name="author" content="Oleksandr Gituliar" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="After five years working as a quant, I can tell that the wast majority of derivative pricing in the financial industry is done on CPU. This is easily explained by two facts: (1) no GPU was available when banks started developing their pricing analytics in 90’s; and (2) banking is a conservative sector, slow to upgrade its technical stack." />
<meta property="og:description" content="After five years working as a quant, I can tell that the wast majority of derivative pricing in the financial industry is done on CPU. This is easily explained by two facts: (1) no GPU was available when banks started developing their pricing analytics in 90’s; and (2) banking is a conservative sector, slow to upgrade its technical stack." />
<link rel="canonical" href="https://tastycode.dev/blog/tasty-gpu-pricing-derivatives-on-a-budget" />
<meta property="og:url" content="https://tastycode.dev/blog/tasty-gpu-pricing-derivatives-on-a-budget" />
<meta property="og:site_name" content="TastyCode" />
<meta property="og:image" content="https://tastycode.dev/assets/img/2023-10-01/bench-512-cpu-gpu.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-01T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://tastycode.dev/assets/img/2023-10-01/bench-512-cpu-gpu.png" />
<meta property="twitter:title" content="Tasty GPU – Pricing Derivatives on a Budget" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Oleksandr Gituliar"},"dateModified":"2023-10-01T00:00:00+02:00","datePublished":"2023-10-01T00:00:00+02:00","description":"After five years working as a quant, I can tell that the wast majority of derivative pricing in the financial industry is done on CPU. This is easily explained by two facts: (1) no GPU was available when banks started developing their pricing analytics in 90’s; and (2) banking is a conservative sector, slow to upgrade its technical stack.","headline":"Tasty GPU – Pricing Derivatives on a Budget","image":"https://tastycode.dev/assets/img/2023-10-01/bench-512-cpu-gpu.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://tastycode.dev/blog/tasty-gpu-pricing-derivatives-on-a-budget"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://tastycode.dev/assets/img/logo-xl.png"},"name":"Oleksandr Gituliar"},"url":"https://tastycode.dev/blog/tasty-gpu-pricing-derivatives-on-a-budget"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div class="content">
    <nav class="flex justify-between pb-6 text-black">
      <a class="block font-bold my-auto text-2xl tracking-tighter text-inherit" style="text-underline-offset: 6px;"
        href="/">
        <img src="/assets/img/logo.png" class="inline-flex py-4 me-2 w-8"><span class="align-middle">TastyCode</span>
      </a>
      <div class=" my-auto text-xl">
        <a class="text-black" href="/about">About</a>
      </div>
    </nav>

    <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tasty GPU – Pricing Derivatives on a Budget</h1>
    <p class="mb-0 post-subtitle flex justify-between">
      <span><time class="dt-published" datetime="2023-10-01T00:00:00+02:00" itemprop="datePublished">
          2023-10-01
        </time>—
        
        <span itemprop="author" itemscope itemtype="http://schema.org/Person">
          <a href="/about" itemprop="name">Oleksandr Gituliar</a></span>
      </span>
      <span>
        Follow on
        <a href="https://www.linkedin.com/in/gituliar/" target="_blank" title="LinkedIn" class="social-media">
          <img src="/assets/img/brands/linkedin.svg" />
        </a>
        <a href="https://github.com/gituliar" target="_blank" title="GitHub" class="social-media">
          <img src="/assets/img/brands/github.svg" />
        </a>
        <a href="https://twitter.com/OGituliar" target="_blank" title="Twitter" class="social-media">
          <img src="/assets/img/brands/twitter.svg" />
        </a>
      </span></p>
  </header>

  <div class="article-body" itemprop="articleBody">
    <p>After five years working as a quant, I can tell that the wast majority of derivative pricing in the
financial industry is done on CPU. This is easily explained by two facts: (1) no GPU was available
when banks started developing their pricing analytics in 90’s; and (2) banking is a conservative
sector, slow to upgrade its technical stack.</p>

<p><strong>American Options.</strong> In this post, I benchmark pricing of American Options on GPU. Since no
analytical formula exist to price American options (similar to the Black-Scholes formula for
European options), people in banks use numerical methods to solve this sort of problems. Such
methods are computationally greedy and, in practice, require a lot of hardware to risk-manage
trading books with thousands of positions.</p>

<p><strong>Finite Difference.</strong> For the benchmark, I use my own implementations of the
<a href="https://en.wikipedia.org/wiki/Finite_difference_method">finite-difference method</a> for CPU and GPU.
When it comes to pricing derivatives, there are two methods, widely-adopted by the industry, that
are capable to solve a wide range of pricing problems. The first one is the famous <strong>Monte-Carlo</strong>
method. Another one is the <strong>Finite-Difference</strong> method, which we will focus on in this post today.</p>

<p>Note, a <u>much faster method</u> to price American Options was recently developed by Andersen et
al. (details below). This method has some constraints (like time-independent coefficients or
log-normal underlying process) and is not a complete replacement for the finite-difference.</p>

<p><strong>Source Code.</strong> The code is written in C++ / CUDA and is available on Github:
<a href="https://github.com/gituliar/kwinto-cuda">https://github.com/gituliar/kwinto-cuda</a>. It’s compatible with Linux and Windows, but requires
Nvidia GPU.</p>

<p>The finite-difference algorithm itself is not very complicated, however deserves a <u>dedicated
post</u> to be fully explained, as there are some nuances here and there. Hopefully, I’ll find some
time to cover this topic later.</p>

<p><strong>Main focus</strong> of the benchmarking is on the following:</p>

<ul>
  <li>How much <u>faster</u> is GPU vs CPU? <br /> Speed is a convenient metric to compare performance,
as faster usually means better (given all other factors equal).</li>
  <li>How much <u>cheaper</u> is GPU vs CPU? <br /> Budget is always important when making decisions.
Speed matters because fast code means less CPU time, but there are other essential factors worth
discussing that impact your budget.</li>
</ul>

<h2 id="benchmark">Benchmark</h2>

<p>My approach is to price american options <u>in batches</u>. This is usually how things are run in
banks, when risk-managing trading books. Every batch contains from 256 to 16’384 american options,
which are priced in parallel utilizing <u>all cores</u> on CPU or GPU.</p>

<p>The total pool of 378’000 options for the benchmark is constructed by permuting all combinations of
the following parameters (with options cheaper than 0.5 rejected). <u>Reference prices</u> are
calculated with <a href="https://github.com/gituliar/kwinto-cuda/blob/main/test/portfolio.py">portfolio.py</a>
in QuantLib, using the
<a href="https://hpcquantlib.wordpress.com/2022/10/09/high-performance-american-option-pricing/">Spanderen implementation</a>
of a high-performance
<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2547027">Andersen-Lake-Offengenden algorithm</a>
for pricing american options.</p>

<table>
  <thead>
    <tr>
      <th>Parameter</th>
      <th>Range</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Parity</td>
      <td>PUT</td>
    </tr>
    <tr>
      <td>Strike</td>
      <td>100</td>
    </tr>
    <tr>
      <td>Spot</td>
      <td>25, 50, 80, 90, 100, 110, 120, 150, 175, 200</td>
    </tr>
    <tr>
      <td>Maturity</td>
      <td>1/12, 0.25, 0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0</td>
    </tr>
    <tr>
      <td>Volatility</td>
      <td>0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5</td>
    </tr>
    <tr>
      <td>Interest rate</td>
      <td>1%, 2%, 3%, 4%, 5%, 6%, 7%, 8%, 9%, 10%</td>
    </tr>
    <tr>
      <td>Dividend rate</td>
      <td>0%, 2%, 4%, 6%, 8%, 10%, 12%</td>
    </tr>
  </tbody>
</table>

<!-- For this project, American options are good candidates for several reasons:

1.  No analytical formula exist to price American options (similar to the Black-Scholes-Merton
    formula for European options), which doesn't make the code artificial / for-benchmark-only.
2.  Since recently, a highly-accurate and fast method to price American options became available,
    (see Andersen et al. \[1\]). We use its implementation from the QuantLib for a crosscheck.
3.  Thirdly, the code can be extended to price exotic options for which no fast method exist. -->

<!-- <figure>
  <img src="/img/fd1d-gpu-z800.png"/>
  <figcaption>This is my caption text.</figcaption>
</figure> -->

<p><strong>Results.</strong> A plot below depicts the main results. Each bin shows how many options are priced per
second (higher is better):</p>

<p><img src="/assets/img/2023-10-01/bench-512-cpu-gpu.png" alt="Benchmark CPU vs GPU" /></p>

<p><strong>US Options Market.</strong> To get some idea about how these results are useful in practice, let’s have a
look at a size of the US options market. The data from <a href="https://www.opraplan.com">OPRA</a> tells that
there are:</p>

<ul>
  <li>5’800 stocks</li>
  <li>680’000 options (with 5%-95% delta)</li>
</ul>

<p>In other words, as per the benchmark, it takes <strong>2 min</strong> to price an entire US Options Market on a
$100 GPU. It should take 10x longer for calibration, which is a more challenging task.</p>

<p>Few things to keep in mind for the results above:</p>

<ol>
  <li>
    <p><strong>GPU is 2x faster</strong> in a <u>single-precision</u> mode (gray bin) vs double-precision (yellow
bin). Meantime, CPU performs more or less the same in both modes (blue and orange bins).</p>

    <p>This is a clear sign that the GPU is limited by <u>data throughput</u>. With its 1’920 cores, the
GPU processes data faster than loads it from the GPU memory.</p>
  </li>
  <li>
    <p><strong>GPU is 4 years older</strong>, which is a big gap for hardware. Nevertheless, the oldish GPU is still
faster than the modern CPU.</p>

    <ul>
      <li><a href="https://www.techpowerup.com/gpu-specs/geforce-gtx-1070.c2840">Nvidia GTX 1070</a>, 16nm –
released in 2016.</li>
      <li><a href="https://www.techpowerup.com/cpu-specs/ryzen-9-5900x.c2363">AMD Ryzen 9 X5900</a>, 7nm – released
in 2020.</li>
    </ul>
  </li>
</ol>

<!-- 3. **GPU loves big batches**, while CPU is most efficient for small jobs. -->

<h2 id="budget">Budget</h2>

<p>In the production environment, <u>faster</u> is almost always means <u>cheaper</u>. Speed is not the
only factor that affects operational costs. Let’s take a look at other factors that appeal in favor
of GPU:</p>

<!-- **Cheap to setup.** In Apr'23, on a secondary market in Denmark I paid $250 for the AMD Ryzen 9
X5900 and only $120 for Nvidia GTX 1070. Obviously, <u>CPU requires</u> a motherboard, RAM, HDD -- a
whole machine -- so final price is 3x higher than that. <u>GPU requires</u> only a PCI-E slot. -->

<p><strong>Cheap to scale.</strong> To run an <u>extra CPU</u> it requires a motherboard, RAM, HDD – a whole new
machine, which quickly becomes expensive to scale.</p>

<p>An <u>extra GPU</u>, however, requires only a PCI-E slot. Some motherboards offer a dozen PCI-E
ports, like <a href="https://www.asrock.com/mb/Intel/Q270%20Pro%20BTC+/index.asp">ASRock Q270 Pro BTC+</a>,
which is especially popular among crypto miners. Such a motherboard can handle <u>17 GPUs on a
single machine</u>. In addition, there is no need to setup a network, manage software on various
machines, and hire an army of devops to automate all that.</p>

<p>This gives extra 3-5x cost reduction in favor of GPU.</p>

<p><strong>Cheap to upgrade.</strong> PCI-E standard is backward compatible, so that new GPU cards are still run on
<u>old machines</u>. Below is the same benchmark run on a much older machine with dual
<a href="https://www.techpowerup.com/cpu-specs/xeon-x5675.c949">Xeon X5675</a> from 2011:</p>

<p><img src="/assets/img/2023-10-01/bench-z800.png" alt="Benchmark CPU vs GPU" /></p>

<p>What immediately catches the eye is that Ryzen 9 outperforms the dual-Xeon machine (both have equal
number of physical cores, btw). This is not a surprise, given a 10-year technological gap.</p>

<p>Surprising is that a newer <u>GPU performs equally well</u> on a much older machine. In practice,
this means that at some point in the future when GPU cards deserve an upgrade there is no need to
upgrade other components, like CPU, motherboard, etc.</p>

<h2 id="summary">Summary</h2>

<p>The <u>Finite-Difference method</u> is a universal and powerful method, heavily used in the
financial industry. However, what is the benefit of running it on GPU ?</p>

<p><strong>Final verdict.</strong> My benchmark shows that:</p>

<ul>
  <li>GPU is 2x faster</li>
  <li>GPU is 3x-5x cheaper</li>
</ul>

<p>This combined gives <u>10x factor</u> in favor of GPU as a platform for pricing derivatives.</p>

  </div>

  <script src="https://giscus.app/client.js" data-repo="tastycode-dev/tastycode-dev.github.io"
    data-repo-id="R_kgDOKGBktA" data-category="Announcements" data-category-id="DIC_kwDOKGBktM4CYmy8"
    data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top"
    data-theme="light" data-lang="en" crossorigin="anonymous" async>
    </script>
</article>
  </div>
</body>

</html>